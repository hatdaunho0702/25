@{
    ViewBag.Title = "Tổng Quan Hệ Thống";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="dashboard-container fade-in-up">
    @* --- PHẦN HIỂN THỊ LỖI NẾU CÓ --- *@
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> <strong>Đã xảy ra lỗi!</strong> @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">👋 Xin chào, Quản trị viên!</h2>
            <p class="text-muted">Tổng quan tình hình kinh doanh SkinFood.</p>
        </div>
        <div>
            <button class="btn btn-primary shadow-sm"><i class="fas fa-download me-2"></i>Xuất Báo Cáo</button>
        </div>
    </div>

    @* --- Hàng 1: Thống kê chính --- *@
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-start-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-uppercase text-muted small fw-bold mb-1">Doanh Thu Tháng</div>
                            <h3 class="text-warning fw-bold mb-0">
                                @String.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:c0}", ViewBag.DoanhThuThangNay ?? 0)
                            </h3>
                        </div>
                        <div class="icon-circle bg-light-warning text-warning">
                            <i class="fas fa-dollar-sign fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-start-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-uppercase text-muted small fw-bold mb-1">Tổng Đơn Hàng</div>
                            <h3 class="text-success fw-bold mb-0">@(ViewBag.TotalDonHang ?? 0)</h3>
                        </div>
                        <div class="icon-circle bg-light-success text-success">
                            <i class="fas fa-shopping-bag fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-start-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-uppercase text-muted small fw-bold mb-1">Tổng Sản Phẩm</div>
                            <h3 class="text-primary fw-bold mb-0">@(ViewBag.TotalSanPham ?? 0)</h3>
                        </div>
                        <div class="icon-circle bg-light-primary text-primary">
                            <i class="fas fa-box-open fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-start-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-uppercase text-muted small fw-bold mb-1">Khách Hàng</div>
                            <h3 class="text-info fw-bold mb-0">@(ViewBag.TotalTaiKhoan ?? 0)</h3>
                        </div>
                        <div class="icon-circle bg-light-info text-info">
                            <i class="fas fa-users fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- Hàng 2: Biểu đồ & Kho --- *@
    <div class="row g-4 mb-4">
        @* Cột Trái: Biểu đồ *@
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-line me-2"></i>Biểu Đồ Doanh Thu</h6>
                    <ul class="nav nav-pills nav-sm" id="chartTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active btn-sm py-1 px-3" data-bs-toggle="tab" data-bs-target="#ngay">Ngày</button></li>
                        <li class="nav-item"><button class="nav-link btn-sm py-1 px-3" data-bs-toggle="tab" data-bs-target="#thang">Tháng</button></li>
                        <li class="nav-item"><button class="nav-link btn-sm py-1 px-3" data-bs-toggle="tab" data-bs-target="#nam">Năm</button></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="chartTabsContent">
                        <div class="tab-pane fade show active" id="ngay"><canvas id="chartNgay" style="height: 350px;"></canvas></div>
                        <div class="tab-pane fade" id="thang"><canvas id="chartThang" style="height: 350px;"></canvas></div>
                        <div class="tab-pane fade" id="nam"><canvas id="chartNam" style="height: 350px;"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        @* Cột Phải: Thông tin kho & Thanh toán *@
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-info"><i class="fas fa-warehouse me-2"></i>Tình Trạng Kho</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="icon-square bg-light-primary text-primary"><i class="fas fa-cubes"></i></div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Tổng tồn kho</h6>
                            <small class="text-muted">Toàn bộ chi nhánh</small>
                        </div>
                        <div class="fw-bold">@(ViewBag.SoLuongTonTatCa ?? 0)</div>
                    </div>
                    <hr class="my-2 dashed">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="icon-square bg-light-danger text-danger"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-danger">Hết hàng</h6>
                            <small class="text-muted">Cần nhập thêm ngay</small>
                        </div>
                        <div class="fw-bold text-danger">@(ViewBag.SanPhamHetHang ?? 0)</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-success"><i class="fas fa-wallet me-2"></i>Dòng Tiền</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small font-weight-bold text-success">Đã thanh toán (@ViewBag.DonHangDaThanhToan đơn)</span>
                            <span class="small text-success">@String.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:c0}", ViewBag.DoanhThuDaThanhToan ?? 0)</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 70%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small font-weight-bold text-warning">Chưa thanh toán (@ViewBag.DonHangChuaThanhToan đơn)</span>
                            <span class="small text-warning">@String.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:c0}", ViewBag.DoanhThuChuaThanhToan ?? 0)</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 30%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- Bảng Đơn Hàng Chờ Thanh Toán --- *@
    @if (ViewBag.DonHangChuaThanhToanTop10 != null && ((List<WebApplication15.Models.DonHang>)ViewBag.DonHangChuaThanhToanTop10).Any())
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-dark"><i class="fas fa-clock me-2 text-warning"></i>Đơn Hàng Chờ Thanh Toán (Mới nhất)</h6>
                <a href="@Url.Action("Index", "DonHang")" class="btn btn-sm btn-light text-primary">Xem tất cả <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted">
                            <tr>
                                <th class="ps-4">Mã ĐH</th>
                                <th>Khách Hàng</th>
                                <th>Tổng Tiền</th>
                                <th>Thời Gian</th>
                                <th>Trạng Thái</th>
                                <th class="text-end pe-4">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dh in (List<WebApplication15.Models.DonHang>)ViewBag.DonHangChuaThanhToanTop10)
                            {
                                TimeSpan thoiGianConLai = DateTime.Now - (dh.NgayDat ?? DateTime.Now);
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#@dh.MaDH</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-light-secondary rounded-circle text-center me-2" style="width:30px; height:30px; line-height:30px;">
                                                <i class="fas fa-user text-secondary" style="font-size: 12px;"></i>
                                            </div>
                                            <span>@(dh.NguoiDung != null ? dh.NguoiDung.HoTen : "Khách vãng lai")</span>
                                        </div>
                                    </td>
                                    <td class="fw-bold">
                                        @String.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:c0}", dh.TongTien ?? 0)
                                    </td>
                                    <td>
                                        <small class="text-muted"><i class="far fa-clock"></i> @thoiGianConLai.Days ngày trước</small>
                                    </td>
                                    <td><span class="badge bg-light-warning text-warning rounded-pill">Chờ thanh toán</span></td>
                                    <td class="text-end pe-4">
                                        <a href="@Url.Action("Details", "DonHang", new { id = dh.MaDH })" class="btn btn-sm btn-light text-info" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Cấu hình chung cho Chart
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.color = '#858796';

        // Lấy dữ liệu từ ViewBag (đã check null ở controller)
        var doanhThuTheoNgay = @Html.Raw(ViewBag.DoanhThuTheoNgay);
        var labelTheoNgay = @Html.Raw(ViewBag.LabelTheoNgay);
        var doanhThuTheoThang = @Html.Raw(ViewBag.DoanhThuTheoThang);
        var labelTheoThang = @Html.Raw(ViewBag.LabelTheoThang);
        var doanhThuTheoNam = @Html.Raw(ViewBag.DoanhThuTheoNam);
        var labelTheoNam = @Html.Raw(ViewBag.LabelTheoNam);

        // Hàm format tiền tệ VN
        const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);

        // 1. Chart Ngày
        var ctxNgay = document.getElementById('chartNgay');
        if(ctxNgay) {
            var ctx = ctxNgay.getContext('2d');
            var gradientNgay = ctx.createLinearGradient(0, 0, 0, 400);
            gradientNgay.addColorStop(0, 'rgba(78, 115, 223, 0.8)');
            gradientNgay.addColorStop(1, 'rgba(78, 115, 223, 0.1)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelTheoNgay,
                    datasets: [{
                        label: 'Doanh Thu',
                        data: doanhThuTheoNgay,
                        backgroundColor: gradientNgay,
                        borderColor: '#4e73df',
                        borderWidth: 1,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: (c) => 'Doanh thu: ' + formatCurrency(c.raw) }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 2. Chart Tháng
        var ctxThang = document.getElementById('chartThang');
        if(ctxThang) {
            new Chart(ctxThang.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labelTheoThang,
                    datasets: [{
                        label: 'Doanh Thu',
                        data: doanhThuTheoThang,
                        borderColor: '#1cc88a',
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        pointRadius: 4,
                        pointBackgroundColor: "#1cc88a",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: (c) => 'Doanh thu: ' + formatCurrency(c.raw) }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 3. Chart Năm
        var ctxNam = document.getElementById('chartNam');
        if(ctxNam) {
            new Chart(ctxNam.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labelTheoNam,
                    datasets: [{
                        label: 'Doanh Thu',
                        data: doanhThuTheoNam,
                        backgroundColor: '#36b9cc',
                        borderRadius: 5,
                        barPercentage: 0.5
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: (c) => 'Doanh thu: ' + formatCurrency(c.raw) }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
}

<style>
    body {
        background-color: #f8f9fc;
        font-family: 'Nunito', sans-serif;
    }

    .fade-in-up {
        animation: fadeInUp 0.5s ease-out;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        border: none;
        border-radius: 0.75rem;
        background-color: #fff;
        transition: transform 0.2s ease-in-out;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
    }

    .shadow-sm {
        box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15) !important;
    }

    .border-start-primary {
        border-left: 0.25rem solid #4e73df !important;
    }

    .border-start-success {
        border-left: 0.25rem solid #1cc88a !important;
    }

    .border-start-info {
        border-left: 0.25rem solid #36b9cc !important;
    }

    .border-start-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }

    .icon-circle {
        height: 3rem;
        width: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-square {
        height: 2.5rem;
        width: 2.5rem;
        border-radius: 0.35rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bg-light-primary {
        background-color: rgba(78, 115, 223, 0.1);
    }

    .bg-light-success {
        background-color: rgba(28, 200, 138, 0.1);
    }

    .bg-light-info {
        background-color: rgba(54, 185, 204, 0.1);
    }

    .bg-light-warning {
        background-color: rgba(246, 194, 62, 0.1);
    }

    .bg-light-danger {
        background-color: rgba(231, 74, 59, 0.1);
    }

    .bg-light-secondary {
        background-color: #eaecf4;
    }

    .text-primary {
        color: #4e73df !important;
    }

    .text-success {
        color: #1cc88a !important;
    }

    .text-info {
        color: #36b9cc !important;
    }

    .text-warning {
        color: #f6c23e !important;
    }

    .text-danger {
        color: #e74a3b !important;
    }

    .nav-pills .nav-link.active {
        background-color: #4e73df;
    }

    .nav-link {
        color: #858796;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.05);
    }

    .dashed {
        border-top: 1px dashed #e3e6f0;
    }
</style>