@model WebApplication15.Models.PhieuNhap

@{
    ViewBag.Title = "Tạo phiếu nhập kho";
    // Bạn kiểm tra lại Layout, thường Admin sẽ dùng _LayoutAdmin.cshtml
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-primary">
            <h6 class="m-0 font-weight-bold text-white"><i class="fa-solid fa-file-circle-plus"></i> Nhập Hàng</h6>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("Create", "PhieuNhap", new { area = "Admin" }, FormMethod.Post, new { id = "formPhieuNhap" }))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="fw-bold">Nhà cung cấp <span class="text-danger">*</span></label>
                        @Html.DropDownListFor(m => m.MaNCC, (SelectList)ViewBag.MaNCC, "-- Chọn Nhà Cung Cấp --", new { @class = "form-control", required = "required", id = "supplierSelect" })
                    </div>
                    <div class="col-md-8">
                        <label class="fw-bold">Ghi chú</label>
                        @Html.TextAreaFor(m => m.GhiChu, new { @class = "form-control", rows = 1 })
                    </div>
                </div>

                <hr />

                <div class="table-responsive">
                    <table class="table table-bordered" id="detailsTable">
                        <thead class="table-light text-center">
                            <tr>
                                <th style="width: 40%">Sản phẩm</th>
                                <th style="width: 15%">Số lượng</th>
                                <th style="width: 20%">Giá nhập</th>
                                <th style="width: 20%">Thành tiền</th>
                                <th style="width: 5%">Xóa</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <select name="details[0].MaSP" class="form-control product-select" required>
                                        <option value="">-- Chọn sản phẩm --</option>
                                    </select>
                                </td>
                                <td><input type="number" name="details[0].SoLuong" class="form-control qty text-center" value="1" min="1" required /></td>
                                <td><input type="number" name="details[0].GiaNhap" class="form-control price text-end" value="0" min="0" required /></td>
                                <td><input type="text" class="form-control total text-end bg-light" readonly value="0" /></td>
                                <td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-row"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">
                                    <button type="button" id="addRow" class="btn btn-success btn-sm"><i class="fa-solid fa-plus"></i> Thêm dòng</button>
                                    <span class="float-end fw-bold text-danger fs-5" id="grandTotal">0 VNĐ</span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary px-4"><i class="fa-solid fa-floppy-disk"></i> Lưu Phiếu Nhập</button>
                    @Html.ActionLink("Quay lại", "Index", null, new { @class = "btn btn-secondary" })
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Lấy dữ liệu trực tiếp từ ViewBag (Anonymous Object)
        var products = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Products));

        $(document).ready(function () {
            // Hàm render tất cả sản phẩm (không lọc theo NCC nữa)
            function renderProductOptions() {
                var html = '<option value="">-- Chọn sản phẩm --</option>';
                if(products && products.length > 0){
                    products.forEach(function(p) {
                        html += '<option value="' + p.MaSP + '">' + p.TenSP + '</option>';
                    });
                }
                return html;
            }

            // Khởi tạo dropdown sản phẩm cho dòng đầu tiên
            $('.product-select').html(renderProductOptions());

            // Tính tiền
            function updateTotals() {
                var grandTotal = 0;
                $('#detailsTable tbody tr').each(function () {
                    var qty = parseFloat($(this).find('.qty').val()) || 0;
                    var price = parseFloat($(this).find('.price').val()) || 0;
                    var total = qty * price;
                    $(this).find('.total').val(total.toLocaleString('vi-VN') + ' đ');
                    grandTotal += total;
                });
                $('#grandTotal').text(grandTotal.toLocaleString('vi-VN') + " VNĐ");
            }

            $(document).on('input', '.qty, .price', updateTotals);

            // Thêm dòng mới
            $('#addRow').click(function () {
                var index = $('#detailsTable tbody tr').length;
                var row = `<tr>
                    <td><select name="details[${index}].MaSP" class="form-control product-select" required>${renderProductOptions()}</select></td>
                    <td><input type="number" name="details[${index}].SoLuong" class="form-control qty text-center" value="1" min="1" required /></td>
                    <td><input type="number" name="details[${index}].GiaNhap" class="form-control price text-end" value="0" min="0" required /></td>
                    <td><input type="text" class="form-control total text-end bg-light" readonly value="0" /></td>
                    <td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-row"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
                $('#detailsTable tbody').append(row);
            });

            // Xóa dòng
            $(document).on('click', '.remove-row', function () {
                if($('#detailsTable tbody tr').length > 1) {
                    $(this).closest('tr').remove();
                    // Cập nhật lại index (quan trọng để MVC nhận được List)
                    updateIndexes();
                    updateTotals();
                } else {
                    alert("Phải có ít nhất 1 dòng sản phẩm!");
                }
            });

            // Hàm cập nhật lại index cho name="details[0]..." sau khi xóa
            function updateIndexes() {
                $('#detailsTable tbody tr').each(function(index) {
                    $(this).find('select[name^="details"]').attr('name', 'details[' + index + '].MaSP');
                    $(this).find('input[name^="details"][name$="SoLuong"]').attr('name', 'details[' + index + '].SoLuong');
                    $(this).find('input[name^="details"][name$="GiaNhap"]').attr('name', 'details[' + index + '].GiaNhap');
                });
            }
        });
    </script>
}