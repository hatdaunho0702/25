<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - SkinFood Shop</title>

    @Styles.Render("~/Content/css")
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="~/Content/styles.scss.css" rel="stylesheet" />
    <style>
        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
            display: inline-block;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .user-avatar-wrap {
            width: 36px;
            height: 36px;
            display: inline-block;
            border-radius: 50%;
            overflow: hidden;
        }

        /* CSS cho Dropdown thông báo */
        .notif-dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 1000;
            min-width: 320px;
            padding: 0;
            margin: 0;
            background-color: #fff;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: .25rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.175);
            list-style: none;
        }

        .notif-container:hover .notif-dropdown-menu {
            display: block;
        }
        /* Hover để hiện menu (hoặc dùng JS click) */
        .notif-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: #333;
        }

        .notif-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f1f1f1;
            display: block;
            text-decoration: none;
            color: #333;
            transition: 0.2s;
        }

            .notif-item:hover {
                background-color: #f8f9fa;
                text-decoration: none;
                color: #000;
            }

        .notif-content {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .notif-time {
            font-size: 11px;
            color: #888;
            text-align: right;
        }

        .badge-notif {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 3px 6px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            font-size: 10px;
        }
    </style>
    <link href="~/CSS/chatbox.css" rel="stylesheet" />
    <link href="~/Content/cssnew.scss.css" rel="stylesheet" />
    <link href="~/Content/responsive.css" rel="stylesheet" />
    <link href="~/Content/MyCusTomLayOut.css" rel="stylesheet" />
    <link href="~/CSS/StyleSheet1.css" rel="stylesheet" />
    @Scripts.Render("~/bundles/modernizr")
</head>

<body>
    @*banner*@
    <section class="top-page-banner" style="text-align: center; background-color: #000; line-height: 0;">
        <a href="#">
            <picture>
                <source media="(min-width:768px)" srcset="https://cdn.hstatic.net/files/1000006063/file/1920x50__dcc483700bc146ce9904885d5c1c11af.jpg" rel="nofollow">
                <source media="(max-width:767px)" srcset="https://cdn.hstatic.net/files/1000006063/file/414x68_2794ebe66cb348e1a76b6f94c2fee1b6.jpg" rel="nofollow">
                <img src="https://cdn.hstatic.net/files/1000006063/file/414x68_2794ebe66cb348e1a76b6f94c2fee1b6.jpg" alt="Banner" style="width:auto; max-width: 100%;" class="ls-is-cached lazyloaded" rel="nofollow">
            </picture>
        </a>
    </section>

    <section class="f-header-top">
        <div class="container">
            <div class="f-header-top-wrap">
                <div class="f-header-top-mb">
                    <a href="javascript:void(0);" class="js-toggle-mobile-menu">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.58611 8.03711C1.15784 8.03711 0 9.13981 0 10.5001C0 11.8603 1.15784 12.963 2.58611 12.963C4.01439 12.963 5.17223 11.8603 5.17223 10.5001C5.17223 9.13981 4.01439 8.03711 2.58611 8.03711Z" fill="#212121"></path>
                        </svg>
                    </a>
                </div>

                <div class="f-header-top-logo">
                    <a href="@Url.Action("Index", "Home")" class="top-logo">
                        <img class="img-fluid" alt="THẾ GIỚI SKINFOOD" src="//theme.hstatic.net/1000006063/1001370907/14/logo.png?v=1968" rel="nofollow">
                    </a>
                </div>

                <div class="f-header-top-search">
                    <form action="@Url.Action("TimKiem", "Home")" method="get" class="d-flex">
                        <input type="text" name="keyword" class="form-control" placeholder="Tìm sản phẩm..." />
                        <button type="submit" class="btn btn-primary ms-2">Tìm</button>
                    </form>
                </div>

                <div class="f-header-top-tools">
                    <div class="f-header-top-info">Hotline: 1900 JQKA</div>
                    <span class="vertical-bar">|</span>

                    @* --- PHẦN LOGIC C# XỬ LÝ USER & THÔNG BÁO --- *@
                    @{
                        // 1. Xác định User
                        var nd = Session["NguoiDung"] as WebApplication15.Models.NguoiDung;
                        var tk = Session["User"] as WebApplication15.Models.TaiKhoan;

                        // Xử lý Avatar
                        string avatarFile = null;
                        if (nd != null) { avatarFile = nd.Avatar; }
                        if (string.IsNullOrEmpty(avatarFile) && tk != null)
                        {
                            var key = "SelectedAvatar_" + tk.MaND;
                            if (Session[key] != null) { avatarFile = Session[key] as string; }
                        }

                        // Tạo link ảnh Avatar
                        string imgSrc = null;
                        if (tk != null) { imgSrc = Url.Action("Avatar", "User", new { maND = tk.MaND }); }
                        if (string.IsNullOrEmpty(imgSrc) && !string.IsNullOrEmpty(avatarFile))
                        {
                            imgSrc = Url.Content("~/Content/avatars/" + avatarFile);
                        }

                        // 2. Lấy danh sách Thông báo (Phản hồi từ Admin)
                        int currentUserId = 0;
                        if (tk != null) { currentUserId = tk.MaND; }
                        else if (nd != null) { currentUserId = nd.MaND; }

                        List<WebApplication15.Models.LienHe> listNotif = new List<WebApplication15.Models.LienHe>();
                        if (currentUserId > 0)
                        {
                            try
                            {
                                using (var db = new WebApplication15.Models.DB_SkinFood1Entities())
                                {
                                    listNotif = db.LienHes
                                        .Where(l => l.MaND == currentUserId && l.TrangThai != null && l.TrangThai.StartsWith("PHANHOI|"))
                                        .OrderByDescending(l => l.NgayGui)
                                        .ToList();
                                }
                            }
                            catch { }
                        }
                    }
                    @* --- KẾT THÚC LOGIC C# --- *@

                    <div class="f-header-top-icons d-flex align-items-center">

                        @* === BẮT ĐẦU: NÚT THÔNG BÁO (MỚI THÊM) === *@
                        <div class="notif-container" style="position: relative; margin-right: 15px; cursor: pointer;">
                            <a href="#" style="color: #212121; position: relative;">
                                <i class="fa-regular fa-bell" style="font-size: 20px;"></i>
                                @if (listNotif != null && listNotif.Count > 0)
                                {
                                    <span class="badge-notif">@listNotif.Count</span>
                                }
                            </a>

                            <ul class="notif-dropdown-menu">
                                <li class="notif-header">Thông báo phản hồi</li>
                                @if (listNotif != null && listNotif.Count > 0)
                                {
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        @foreach (var item in listNotif)
                                        {
                                            string phanHoi = item.TrangThai.Replace("PHANHOI|", "");
                                            <a href="@Url.Action("Index", "LienHe")" class="notif-item">
                                                <div style="font-weight: bold; color: #007bff; font-size: 13px;">
                                                    <i class="fa fa-reply"></i> Admin phản hồi:
                                                </div>
                                                <div class="notif-content">@phanHoi</div>
                                                <div class="text-muted" style="font-size: 11px;">
                                                    Câu hỏi: @(item.NoiDung.Length > 25 ? item.NoiDung.Substring(0, 25) + "..." : item.NoiDung)
                                                </div>
                                                <div class="notif-time">
                                                    @(item.NgayGui.HasValue ? item.NgayGui.Value.ToString("dd/MM/yyyy HH:mm") : "")
                                                </div>
                                            </a>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <li class="p-3 text-center text-muted">Không có thông báo mới</li>
                                }
                            </ul>
                        </div>
                        @* === KẾT THÚC: NÚT THÔNG BÁO === *@


                        @* Icon Tài khoản (Giữ nguyên) *@
                        <a href="@Url.Action("Account", "User")" class="f-header-top-icon-account" title="Tài khoản" style="margin-right: 15px;">
                            @if (!string.IsNullOrEmpty(imgSrc))
                            {
                                <span class="user-avatar-wrap"><img src="@imgSrc" alt="avatar" class="user-avatar" /></span>
                            }
                            else
                            {
                                <svg width="22" height="21" viewBox="0 0 22 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M11 13.125C14.3827 13.125 17.125 10.3827 17.125 7C17.125 3.61726 14.3827 0.875 11 0.875C7.61723 0.875 4.87497 3.61726 4.87497 7C4.87497 10.3827 7.61723 13.125 11 13.125ZM11 14C14.866 14 18 10.866 18 7C18 3.13401 14.866 0 11 0C7.13398 0 3.99997 3.13401 3.99997 7C3.99997 10.866 7.13398 14 11 14Z" fill="#212121"></path>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.859157 20.9996C0.859202 20.9994 0.859254 20.9991 0.429561 20.8972C-0.000131505 20.7952 -6.79857e-05 20.7949 1.77457e-06 20.7946L0.000172552 20.7938L0.000627901 20.7917L0.00200095 20.7855L0.00665644 20.7651C0.0106313 20.748 0.0163807 20.724 0.0240861 20.6937C0.0394944 20.6329 0.0627409 20.5464 0.0952824 20.4378C0.160337 20.2207 0.262719 19.9148 0.414187 19.5496C0.716819 18.82 1.21751 17.8489 2.01193 16.8775C3.61168 14.9212 6.37431 13 11 13C15.6257 13 18.3883 14.9212 19.9881 16.8775C20.7825 17.8489 21.2832 18.82 21.5858 19.5496C21.7373 19.9148 21.8397 20.2207 21.9047 20.4378C21.9373 20.5464 21.9605 20.6329 21.9759 20.6937C21.9836 20.724 21.9894 20.748 21.9933 20.7651L21.998 20.7855L21.9994 20.7917L21.9998 20.7938L22 20.7946C22.0001 20.7949 22.0001 20.7952 21.5704 20.8972C21.1407 20.9991 21.1408 20.9994 21.1408 20.9996L21.1405 20.9981L21.1379 20.9866C21.1353 20.9756 21.1311 20.9578 21.125 20.9337C21.1128 20.8856 21.0932 20.8124 21.0648 20.7178C21.008 20.5284 20.9164 20.2537 20.7788 19.922C20.5034 19.258 20.0461 18.3709 19.321 17.4843C17.8818 15.7242 15.3592 13.9291 11 13.9291C6.64081 13.9291 4.11823 15.7242 2.67897 17.4843C1.9539 18.3709 1.49664 19.258 1.2212 19.922C1.08363 20.2537 0.99195 20.5284 0.935197 20.7178C0.906834 20.8124 0.887241 20.8856 0.875037 20.9337C0.868935 20.9578 0.864685 20.9756 0.862111 20.9866L0.859488 20.9981L0.859157 20.9996ZM21.1409 20.9999C21.1409 21 21.1409 21 21.1409 20.9999L21.1409 20.9999Z" fill="#212121"></path>
                                </svg>
                            }
                        </a>

                        @* Icon Giỏ hàng (Giữ nguyên) *@
                        <a href="@Url.Action("Index", "GioHang")" class="f-header-top-icon-cart" style="margin-right: 15px;">
                            <svg width="17" height="23" viewBox="0 0 17 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.4591 6.78643C16.4536 6.78643 16.4536 6.78643 16.4481 6.78643H13.2468V4.44242C13.2468 1.99161 11.1714 0 8.63799 0C6.10455 0 4.02922 1.99161 4.02922 4.44242V6.78643H0.551948C0.253896 6.78109 0.00551948 7.01069 0 7.29902C0 7.30436 0 7.30436 0 7.30969V19.772C0 21.2456 1.23636 22.4363 2.75974 22.4363H14.2403C15.7636 22.4363 17 21.2456 17 19.772V7.30969C17 7.02136 16.7571 6.78643 16.4591 6.78643ZM5.13312 4.44242C5.13312 2.57895 6.71169 1.06789 8.63799 1.06789C10.5643 1.06789 12.1429 2.57895 12.1429 4.44242V6.78643H5.13312V4.44242ZM15.8961 19.7666C15.8961 20.6476 15.1565 21.3631 14.2403 21.3631H2.75974C1.84903 21.3631 1.1039 20.653 1.1039 19.772V7.85432H4.02922V10.9565C4.02922 11.2502 4.2776 11.4905 4.58117 11.4905C4.88474 11.4905 5.13312 11.2502 5.13312 10.9565V7.85432H12.1429V10.9565C12.1429 11.2502 12.3912 11.4905 12.6948 11.4905C12.9984 11.4905 13.2468 11.2502 13.2468 10.9565V7.85432H15.8961V19.7666Z" fill="#212121"></path>
                            </svg>
                            <sup class="badge bg-danger">
                                @(Session["Cart"] != null ? ((WebApplication15.Models.Cart)Session["Cart"]).SoMatHang() : 0)
                            </sup>
                        </a>

                        @* Icon Liên hệ (Giữ nguyên) *@
                        <a href="@Url.Action("Index", "LienHe")" class="f-header-top-icon-account">
                            <i class="bi bi-telephone-fill" style="font-size: 20px;"></i>
                        </a>

                        <a href="javascript:void(0)" class="f-header-top-icon-menu">
                            <svg width="19" height="10" viewBox="0 0 19 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <line x1="19" y1="0.5" y2="0.5" stroke="#212121"></line>
                                <line x1="19" y1="9.5" y2="9.5" stroke="#212121"></line>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    @Html.Action("MenuChinh", "Home")

    <div class="container body-content">
        @RenderBody()
        <hr />

        <footer class="footer-pink pt-5 pb-4 mt-5">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 col-sm-12 mb-4">
                        <h5 class="footer-title">SkinFood Shop</h5>
                        <p class="footer-text">
                            Mỹ phẩm chính hãng – an toàn – chất lượng.
                            Tự tin lan tỏa vẻ đẹp tự nhiên của bạn!
                        </p>
                        <p class="footer-text"><i class="bi bi-geo-alt-fill"></i> 140 Lê Trọng Tấn, TP.HCM</p>
                        <p class="footer-text"><i class="bi bi-telephone-fill"></i> 0911513170</p>
                        <p class="footer-text"><i class="bi bi-envelope-fill"></i> skinfood@gmail.com</p>
                        <div class="d-flex gap-3 fs-4 mt-2">
                            <a href="#" class="social-icon"><i class="fa-brands fa-facebook"></i></a>
                            <a href="#" class="social-icon"><i class="fa-brands fa-instagram"></i></a>
                            <a href="#" class="social-icon"><i class="fa-brands fa-youtube"></i></a>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6 mb-4">
                        <h5 class="footer-title">Danh mục</h5>
                        <ul class="list-unstyled">
                            <li><a class="footer-link" href="#">Chăm sóc da</a></li>
                            <li><a class="footer-link" href="#">Trang điểm</a></li>
                            <li><a class="footer-link" href="#">Nước hoa</a></li>
                            <li><a class="footer-link" href="#">Sản phẩm Sale</a></li>
                        </ul>
                    </div>

                    <div class="col-md-4 col-sm-6 mb-4">
                        <h5 class="footer-title">Hỗ trợ</h5>
                        <ul class="list-unstyled">
                            <li><a class="footer-link" href="/LienHe/HuongDanMuaHang">Hướng dẫn mua hàng</a></li>
                            <li><a class="footer-link" href="/LienHe/ChinhSachDoiTra">Chính sách đổi trả</a></li>
                            <li><a class="footer-link" href="/LienHe/ChinhSachBaoMat">Chính sách bảo mật</a></li>
                            <li><a class="footer-link" href="/LienHe/Index">Liên hệ</a></li>
                        </ul>
                    </div>
                </div>
                <hr class="footer-line" />
                <div class="text-center footer-copy">
                    © @DateTime.Now.Year SkinFood – Đẹp mỗi ngày cùng bạn 🌸
                </div>
            </div>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)

    @Html.Partial("_ChatBox")
    <script src="~/CSS/chatbox.js"></script>

    @* Script xử lý hover cho dropdown menu thông báo *@
    <script>
        $(document).ready(function () {
            // Nếu dùng mobile, click để mở menu
            $('.notif-container > a').click(function (e) {
                if ($(window).width() < 768) {
                    e.preventDefault();
                    $(this).next('.notif-dropdown-menu').toggle();
                }
            });
        });
    </script>
</body>
</html>