using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Linq;
using System.Web.Mvc;
using WebApplication15.Models; // Đảm bảo namespace đúng

namespace WebApplication15.Areas.Admin.Controllers
{
    // [AuthorizeAdmin] // Bỏ comment nếu bạn đã có class AuthorizeAdmin
    public class PhieuNhapController : Controller
    {
        private DB_SkinFood1Entities db = new DB_SkinFood1Entities();

        protected override void Dispose(bool disposing)
        {
            if (disposing) db?.Dispose();
            base.Dispose(disposing);
        }

        // 1. TRANG DANH SÁCH (Sửa lỗi 404)
        // GET: Admin/PhieuNhap
        public ActionResult Index()
        {
            // Eager load ChiTietPhieuNhaps so we can compute/display Totals reliably in the view
            var list = db.PhieuNhaps
                         .Include("ChiTietPhieuNhaps")
                         .Include("NhaCungCap")
                         .OrderByDescending(x => x.NgayNhap)
                         .ToList();
            return View(list);
        }

        // Utility: Recalculate totals for existing PhieuNhaps from their ChiTietPhieuNhaps
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult RecalculateTotals()
        {
            try
            {
                var phieus = db.PhieuNhaps.Include("ChiTietPhieuNhaps").ToList();
                int updated = 0;
                foreach (var p in phieus)
                {
                    decimal sum = 0m;
                    if (p.ChiTietPhieuNhaps != null && p.ChiTietPhieuNhaps.Any())
                    {
                        foreach (var ct in p.ChiTietPhieuNhaps)
                        {
                            decimal line = 0m;
                            if (ct.ThanhTien.HasValue)
                                line = ct.ThanhTien.Value;
                            else
                            {
                                var qty = ct.SoLuong ?? 0;
                                var gia = ct.GiaNhap ?? 0m;
                                line = qty * gia;
                            }

                            sum += line;
                        }
                    }

                    if (p.TongTien == null || p.TongTien != sum)
                    {
                        p.TongTien = sum;
                        db.Entry(p).State = EntityState.Modified;
                        updated++;
                    }
                }

                db.SaveChanges();
                TempData["SuccessMessage"] = $"Đã cập nhật tổng tiền cho {updated} phiếu nhập.";
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = "Lỗi khi cập nhật tổng tiền: " + ex.Message;
            }

            return RedirectToAction("Index");
        }

        // Details: Hiển thị chi tiết một phiếu nhập
        // GET: Admin/PhieuNhap/Details/5
        public ActionResult Details(int? id)
        {
            if (id == null)
            {
                return new HttpStatusCodeResult(400);
            }

            // Eager load chi tiết và sản phẩm để tránh lazy loading khi context đã bị dispose
            var phieu = db.PhieuNhaps
                          .Include("ChiTietPhieuNhaps.SanPham")
                          .Include("NhaCungCap")
                          .FirstOrDefault(p => p.MaPN == id.Value);

            if (phieu == null)
            {
                return HttpNotFound();
            }

            return View(phieu);
        }

        // 2. TRANG TẠO MỚI
        // GET: Admin/PhieuNhap/Create
        public ActionResult Create()
        {
            ViewBag.MaNCC = new SelectList(db.NhaCungCaps.ToList(), "MaNCC", "TenNCC");

            // Truyền danh sách sản phẩm đã được project để tránh vòng tham chiếu khi serialize JSON
            var safeProducts = db.SanPhams
                // Chỉ lấy những trường cần thiết để tối ưu hiệu suất
                .Select(p => new
                {
                    p.MaSP,
                    p.TenSP,
                    GiaBan = p.GiaBan ?? 0m,
                    SoLuongTon = p.SoLuongTon ?? 0
                })
                .ToList();

            ViewBag.Products = safeProducts;

            // Thêm danh sách suppliers để dùng trong JS
            ViewBag.Suppliers = db.NhaCungCaps.ToList();
            return View();
        }

        // 3. XỬ LÝ LƯU (POST)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Create(PhieuNhap phieuNhap, List<ChiTietPhieuNhap> details)
        {
            // --- 1. Lọc và kiểm tra danh sách chi tiết ---
            if (details != null)
            {
                details.RemoveAll(x => (x.MaSP <= 0) || ((x.SoLuong ?? 0) <= 0));
            }

            if (details == null || details.Count == 0)
            {
                ModelState.AddModelError("", "Phiếu nhập phải có ít nhất 1 sản phẩm hợp lệ.");
            }

            // --- 2. Nếu dữ liệu hợp lệ thì thực hiện Transaction ---
            if (ModelState.IsValid)
            {
                using (var tran = db.Database.BeginTransaction())
                {
                    try
                    {
                        // Lưu Header
                        phieuNhap.NgayNhap = DateTime.Now; // (Optional) Gán ngày nhập nếu cần
                        db.PhieuNhaps.Add(phieuNhap);
                        db.SaveChanges(); // Save để lấy MaPN tự tăng

                        foreach (var d in details)
                        {
                            // Gán MaPN cho chi tiết
                            d.MaPN = phieuNhap.MaPN;

                            d.ThanhTien = (d.SoLuong ?? 0) * (d.GiaNhap ?? 0);

                            db.ChiTietPhieuNhaps.Add(d);

                            // NOTE: Không cập nhật SoLuongTon ở đây vì trigger DB trg_CapNhatKho_Nhap sẽ tự động cập nhật khi chi tiết được ghi vào.
                            // Nếu vẫn cập nhật trong C# thì sẽ bị cộng 2 lần (trigger + code) dẫn tới số lượng gấp đôi.
                        }

                        // Compute total for the PhieuNhap header and save it
                        phieuNhap.TongTien = details.Sum(x => (x.ThanhTien ?? 0m));
                        db.Entry(phieuNhap).State = EntityState.Modified;

                        db.SaveChanges();
                        tran.Commit();

                        // >>> THÀNH CÔNG: Chuyển hướng
                        return RedirectToAction("Index");
                    }
                    catch (Exception ex)
                    {
                        tran.Rollback();
                        // Ghi lỗi vào ModelState để hiển thị ra View
                        ModelState.AddModelError("", "Có lỗi xảy ra khi lưu: " + ex.Message);
                    }
                }
            }

            // --- 3. XỬ LÝ KHI CÓ LỖI (Validation sai HOẶC Exception) ---
            // Code sẽ chạy xuống đây nếu:
            // a. ModelState.IsValid == false
            // b. Bị nhảy vào catch (Exception)

            // Phải nạp lại ViewBag để Dropdown không bị lỗi null
            ViewBag.MaNCC = new SelectList(db.NhaCungCaps.ToList(), "MaNCC", "TenNCC", phieuNhap?.MaNCC);

            ViewBag.Products = db.SanPhams
                .Select(p => new
                {
                    p.MaSP,
                    p.TenSP,
                    GiaBan = p.GiaBan ?? 0m,
                    SoLuongTon = p.SoLuongTon ?? 0
                })
                .ToList();

            ViewBag.Suppliers = db.NhaCungCaps.ToList();

            // >>> TRẢ VỀ VIEW ĐỂ SỬA LỖI
            return View(phieuNhap);
        }
    }
}