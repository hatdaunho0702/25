using System;
using System.Collections.Generic;
using System.Data.Entity.Validation;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using WebApplication15.Models;
using WebApplication15.Services;

namespace WebApplication15.Controllers
{
    public class GioHangController : Controller
    {
        private DB_SkinFood1Entities data = new DB_SkinFood1Entities();

        protected override void Dispose(bool disposing)
        {
            if (disposing) data?.Dispose();
            base.Dispose(disposing);
        }

        // =========================================================================
        // 1. CÁC HÀM QUẢN LÝ GIỎ HÀNG (GIỮ NGUYÊN)
        // =========================================================================

        // GET: GioHang
        public ActionResult Index()
        {
            var cart = Session["Cart"] as Cart;
            if (cart == null) cart = new Cart();

            decimal tamTinh = cart.TongThanhTien();
            decimal discount = 0m;
            if (Session["DiscountAmount"] != null)
            {
                try { discount = Convert.ToDecimal(Session["DiscountAmount"]); } catch { discount = 0m; }
            }

            decimal tongCong = tamTinh - discount;
            if (tongCong < 0) tongCong = 0;

            ViewBag.TamTinh = tamTinh;
            ViewBag.Discount = discount;
            ViewBag.TongCong = tongCong;

            return View(cart);
        }

        public ActionResult AddToCart(int id)
        {
            if (Session["User"] == null) return RedirectToAction("Login", "User");
            Cart cart = (Cart)Session["Cart"] ?? new Cart();

            if (cart.Them(id) == 1)
            {
                Session["Cart"] = cart;
                RecalculateDiscount();
            }
            return RedirectToAction("Index", "Home");
        }

        public ActionResult ThemGioHang(int maSP, string url = null)
        {
            if (Session["User"] == null) return RedirectToAction("Login", "User");
            Cart cart = (Cart)Session["Cart"] ?? new Cart();

            if (cart.Them(maSP) == 1)
            {
                Session["Cart"] = cart;
                RecalculateDiscount();
            }

            if (!string.IsNullOrEmpty(url) && Url.IsLocalUrl(url)) return Redirect(url);
            var refUrl = Request.UrlReferrer?.ToString();
            if (!string.IsNullOrEmpty(refUrl) && Url.IsLocalUrl(refUrl)) return Redirect(refUrl);
            return RedirectToAction("Index", "Home");
        }

        public ActionResult RemoveFromCart(int id)
        {
            if (Session["User"] == null) return RedirectToAction("Login", "User");
            Cart cart = (Cart)Session["Cart"] ?? new Cart();

            if (cart.Xoa(id) == 1)
            {
                Session["Cart"] = cart;
                RecalculateDiscount();
                // Logic hủy đơn pending nếu khách xóa sạch giỏ (Giữ nguyên logic của bạn)
                try
                {
                    var user = Session["User"] as TaiKhoan;
                    if (user != null)
                    {
                        var donHang = data.DonHangs.Where(d => d.MaND == user.MaND && d.TrangThaiThanhToan == "Chưa thanh toán").OrderByDescending(d => d.NgayDat).FirstOrDefault();
                        if (donHang != null)
                        {
                            donHang.TrangThaiThanhToan = "Đã hủy";
                            donHang.GhiChu += " | Khách xóa SP khỏi giỏ";
                            data.SaveChanges();
                        }
                    }
                }
                catch { }
            }
            return RedirectToAction("Index", "GioHang");
        }

        public ActionResult UpdateSLCart(int id, int num)
        {
            Cart cart = (Cart)Session["Cart"] ?? new Cart();
            int result = (num == -1) ? cart.Giam(id) : cart.Them(id);

            if (result == 1)
            {
                Session["Cart"] = cart;
                RecalculateDiscount();
            }
            return RedirectToAction("Index", "GioHang");
        }

        [HttpPost]
        public ActionResult UpdateQuantity(int id, int quantity)
        {
            Cart cart = (Cart)Session["Cart"] ?? new Cart();
            var item = cart.list.FirstOrDefault(x => x.MaSP == id);
            if (item != null)
            {
                if (quantity <= 0) cart.Xoa(id);
                else item.SoLuong = quantity;

                Session["Cart"] = cart;
                RecalculateDiscount();
            }
            return RedirectToAction("Index", "GioHang");
        }

        // =========================================================================
        // 2. THANH TOÁN & XỬ LÝ ĐƠN HÀNG (QUAN TRỌNG NHẤT)
        // =========================================================================

        public ActionResult PaymentReview()
        {
            Cart cart = (Cart)Session["Cart"];
            if (cart == null || cart.list.Count == 0) return RedirectToAction("Index", "GioHang");
            return View(cart);
        }

        // --- HÀM THANH TOÁN CHÍNH: ĐÃ SỬA ĐỂ KHỚP VỚI SQL TRIGGER ---
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult PaymentConfirm(string tenNguoiNhan, string soDienThoai, string diaChi, string ghiChu, string phuongThuc = "COD")
        {
            var cart = Session["Cart"] as Cart;
            if (cart == null || !cart.list.Any())
            {
                TempData["Error"] = "Giỏ hàng rỗng.";
                return RedirectToAction("Index");
            }

            var user = Session["User"] as TaiKhoan;
            if (user == null)
            {
                TempData["Error"] = "Vui lòng đăng nhập.";
                return RedirectToAction("Login", "User");
            }

            // Tính tiền
            decimal tongTien = cart.TongThanhTien();
            decimal giamGia = 0m;
            if (Session["DiscountAmount"] != null) decimal.TryParse(Session["DiscountAmount"].ToString(), out giamGia);
            decimal tongThanhToan = tongTien - giamGia;
            if (tongThanhToan < 0) tongThanhToan = 0;

            // Dùng Transaction để đảm bảo an toàn dữ liệu
            using (var transaction = data.Database.BeginTransaction())
            {
                try
                {
                    // B1: Tạo Đơn Hàng
                    var dh = new DonHang
                    {
                        MaND = user.MaND,
                        NgayDat = DateTime.Now,
                        TongTien = tongThanhToan,
                        SoTienGiam = giamGia,
                        TenNguoiNhan = tenNguoiNhan,
                        SoDienThoai = soDienThoai,
                        DiaChiGiaoHang = diaChi,
                        GhiChu = ghiChu,
                        TrangThaiThanhToan = "Chưa thanh toán",
                        PhuongThucThanhToan = phuongThuc
                    };

                    try
                    {
                        var coupon = Session["Discount"] as KhuyenMai;
                        if (coupon != null) dh.MaKM = coupon.MaKM;
                    }
                    catch { }

                    data.DonHangs.Add(dh);
                    data.SaveChanges(); // Lưu để lấy ID Đơn Hàng

                    // B2: Tạo Chi Tiết Đơn Hàng (SQL TRIGGER SẼ TỰ TRỪ KHO TẠI ĐÂY)
                    foreach (var item in cart.list)
                    {
                        var ct = new ChiTietDonHang
                        {
                            MaDH = dh.MaDH,
                            MaSP = item.MaSP,
                            SoLuong = item.SoLuong,
                            DonGia = (decimal)item.GiaBan
                        };
                        data.ChiTietDonHangs.Add(ct);
                        // LƯU Ý: KHÔNG viết code trừ kho ở đây (sp.SoLuongTon -= ...) 
                        // vì Trigger SQL 'trg_CapNhatKho_BanHang' sẽ tự làm việc đó.
                    }

                    data.SaveChanges(); // Lưu chi tiết -> Trigger chạy kiểm tra tồn kho
                    transaction.Commit(); // Nếu không lỗi -> Xác nhận thành công

                    // B3: Hoàn tất
                    Session["CurrentOrder"] = dh.MaDH;

                    if (phuongThuc.Equals("COD", StringComparison.OrdinalIgnoreCase))
                    {
                        ClearCartSession(); // Xóa giỏ hàng
                        return RedirectToAction("PaymentSuccess", new { maDH = dh.MaDH });
                    }
                    if (phuongThuc.Equals("BankTransfer", StringComparison.OrdinalIgnoreCase))
                        return RedirectToAction("ThanhToanChuyenKhoan", new { maDH = dh.MaDH });
                    if (phuongThuc.Equals("QR", StringComparison.OrdinalIgnoreCase))
                        return RedirectToAction("ThanhToanQR", new { maDH = dh.MaDH });

                    return RedirectToAction("PaymentSuccess", new { maDH = dh.MaDH });
                }
                catch (DbEntityValidationException valEx)
                {
                    transaction.Rollback();
                    string msg = "";
                    foreach (var err in valEx.EntityValidationErrors)
                        foreach (var x in err.ValidationErrors) msg += $"- {x.PropertyName}: {x.ErrorMessage} <br>";
                    TempData["Error"] = "Lỗi dữ liệu: " + msg;
                    return RedirectToAction("PaymentReview");
                }
                catch (Exception ex)
                {
                    transaction.Rollback();
                    // Lấy lỗi gốc từ SQL Trigger (ví dụ: "Sản phẩm đã hết hàng...")
                    string msg = ex.Message;
                    if (ex.InnerException != null)
                    {
                        msg = ex.InnerException.Message;
                        if (ex.InnerException.InnerException != null)
                            msg = ex.InnerException.InnerException.Message;
                    }

                    // Nếu lỗi liên quan tới tồn kho do trigger, cập nhật lại giỏ hàng theo stock hiện tại
                    try
                    {
                        var cartCurrent = Session["Cart"] as Cart;
                        if (cartCurrent != null && cartCurrent.list != null)
                        {
                            bool changed = false;
                            foreach (var it in cartCurrent.list.ToList())
                            {
                                var sp = data.SanPhams.Find(it.MaSP);
                                int available = sp?.SoLuongTon ?? 0;
                                if (available <= 0)
                                {
                                    // remove item if none left
                                    cartCurrent.list.Remove(it);
                                    changed = true;
                                }
                                else if (available < it.SoLuong)
                                {
                                    it.SoLuong = available;
                                    changed = true;
                                }
                            }
                            if (changed)
                            {
                                Session["Cart"] = cartCurrent;
                                // Recalculate discount and any totals after modifying cart
                                try { RecalculateDiscount(); } catch { }
                            }
                        }
                    }
                    catch { /* ignore any error while updating session cart */ }

                    TempData["Error"] = "Lỗi thanh toán: " + msg + " Vui lòng kiểm tra lại giỏ hàng (số lượng đã cập nhật).";
                    return RedirectToAction("PaymentReview");
                }
            }
        }

        public ActionResult ThanhToanCOD(int? maDH)
        {
            // Hàm này chỉ để redirect cho đúng luồng, vì PaymentConfirm đã xử lý logic rồi
            if (maDH.HasValue) return RedirectToAction("PaymentSuccess", new { maDH = maDH });
            return RedirectToAction("Index", "Home");
        }

        public ActionResult PaymentSuccess(int? maDH)
        {
            if (!maDH.HasValue) maDH = (int?)Session["CurrentOrder"];
            if (maDH.HasValue)
            {
                ViewBag.MaDH = maDH.Value;
                var dh = data.DonHangs.Find(maDH);
                if (dh != null)
                {
                    data.Entry(dh).Reload(); // Cập nhật trạng thái mới nhất
                    if (string.IsNullOrEmpty(dh.TrangThaiThanhToan))
                    {
                        dh.TrangThaiThanhToan = "Đã thanh toán"; // Fallback nếu cần
                        data.SaveChanges();
                    }
                    ViewBag.TrangThaiThanhToan = dh.TrangThaiThanhToan;
                    ViewBag.PhuongThucThanhToan = dh.PhuongThucThanhToan;
                }
            }
            ClearCartSession();
            TempData["PaymentSuccess"] = "Đặt hàng thành công!";
            return View();
        }

        // =========================================================================
        // 3. CÁC HÀM PHỤ TRỢ KHÁC (GIỮ NGUYÊN)
        // =========================================================================

        public ActionResult LuuThongTinNhanHang(int? maDH)
        {
            if (!maDH.HasValue) maDH = (int?)Session["CurrentOrder"];
            if (!maDH.HasValue) return RedirectToAction("Index");
            var dh = data.DonHangs.Find(maDH);
            return (dh == null) ? (ActionResult)RedirectToAction("Index") : View(dh);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult LuuThongTinNhanHang(int MaDH, string TenNguoiNhan, string SoDienThoai, string DiaChiGiaoHang, string GhiChu)
        {
            var dh = data.DonHangs.Find(MaDH);
            if (dh != null)
            {
                dh.TenNguoiNhan = TenNguoiNhan;
                dh.SoDienThoai = SoDienThoai;
                dh.DiaChiGiaoHang = DiaChiGiaoHang;
                dh.GhiChu = GhiChu;
                data.SaveChanges();
                return RedirectToAction("PaymentMethod", new { maDH = MaDH }); // Hoặc trang tiếp theo của bạn
            }
            return RedirectToAction("Index");
        }

        // Xóa Session giỏ hàng (Chỉ giữ 1 bản duy nhất ở đây)
        private void ClearCartSession()
        {
            Session["Cart"] = null;
            Session["Discount"] = null;
            Session["DiscountCode"] = null;
            Session["DiscountAmount"] = null;
            try
            {
                var user = Session["User"] as TaiKhoan;
                if (user != null) data.Database.ExecuteSqlCommand("DELETE FROM SavedCarts WHERE MaND = @p0", user.MaND);
            }
            catch { }
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult ApplyDiscountAjax(string maGiamGia)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(maGiamGia)) return Json(new { success = false, message = "Nhập mã đi bạn." }, JsonRequestBehavior.AllowGet);
                var cart = Session["Cart"] as Cart;
                if (cart == null || !cart.list.Any()) return Json(new { success = false, message = "Giỏ trống." }, JsonRequestBehavior.AllowGet);

                decimal tamTinh = cart.TongThanhTien();
                var sv = new CouponService(data);
                var km = sv.GetValidCoupon(maGiamGia.Trim(), tamTinh);

                if (km == null) return Json(new { success = false, message = "Mã không hợp lệ." }, JsonRequestBehavior.AllowGet);

                decimal giam = (km.GiaTriGiam <= 100) ? (tamTinh * km.GiaTriGiam / 100) : km.GiaTriGiam;
                if (giam > tamTinh) giam = tamTinh;

                Session["Discount"] = km; Session["DiscountCode"] = km.MaCode; Session["DiscountAmount"] = giam;

                return Json(new
                {
                    success = true,
                    subTotalFormatted = tamTinh.ToString("N0") + "₫",
                    discountAmountFormatted = giam.ToString("N0") + "₫",
                    finalTotalFormatted = (tamTinh - giam).ToString("N0") + "₫",
                    discountCode = km.MaCode
                }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex) { return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet); }
        }

        private void RecalculateDiscount()
        {
            try
            {
                var code = Session["DiscountCode"] as string;
                var cart = Session["Cart"] as Cart;
                if (string.IsNullOrWhiteSpace(code) || cart == null)
                {
                    Session["Discount"] = null; Session["DiscountAmount"] = null; Session["DiscountCode"] = null; return;
                }
                decimal tamTinh = cart.TongThanhTien();
                var km = new CouponService(data).GetValidCoupon(code, tamTinh);
                if (km == null)
                {
                    Session["Discount"] = null; Session["DiscountAmount"] = null; Session["DiscountCode"] = null; return;
                }
                decimal giam = (km.GiaTriGiam <= 100) ? (tamTinh * km.GiaTriGiam / 100) : km.GiaTriGiam;
                if (giam > tamTinh) giam = tamTinh;
                Session["DiscountAmount"] = giam;
            }
            catch { }
        }

        public ActionResult DebugPayment(int maDH)
        {
            try { return Content("Debug: " + maDH); } catch (Exception ex) { return Content(ex.Message); }
        }

        // Các trang View phụ
        public ActionResult ThanhToanChuyenKhoan(int? maDH)
        {
            if (!maDH.HasValue) maDH = (int?)Session["CurrentOrder"];
            var dh = data.DonHangs.Find(maDH); return (dh != null) ? View(dh) : (ActionResult)RedirectToAction("Index");
        }
        public ActionResult ThanhToanQR(int? maDH)
        {
            if (!maDH.HasValue) maDH = (int?)Session["CurrentOrder"];
            var dh = data.DonHangs.Find(maDH); return (dh != null) ? View(dh) : (ActionResult)RedirectToAction("Index");
        }
        public ActionResult ConfirmPaymentComplete(int? maDH)
        {
            if (!maDH.HasValue) maDH = (int?)Session["CurrentOrder"];
            var dh = data.DonHangs.Find(maDH);
            if (dh != null) { dh.TrangThaiThanhToan = "Đã thanh toán"; data.SaveChanges(); ClearCartSession(); }
            return RedirectToAction("Index", "Home");
        }
    }
}