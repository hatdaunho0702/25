@model List<WebApplication15.Models.SanPham>
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<h2>📦 Quản lý sản phẩm</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex">
        <a href="@Url.Action("Create")" class="btn btn-success me-2">+ Thêm sản phẩm</a>
        <button id="btnDeleteSelected" class="btn btn-danger me-2">🗑️ Xóa đã chọn</button>
        <button id="btnDeleteAll" class="btn btn-danger">🗑️ Xóa tất cả</button>
    </div>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>⚠️ Lỗi!</strong> @TempData["ErrorMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>✅ Thành công!</strong> @TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<!-- Thống Kê Tồn Kho -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <strong>📊 Thống Kê Tồn Kho</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h5>Tổng Số Lượng Tồn Kho</h5>
                        <h3 class="text-primary">@Model.Sum(s => s.SoLuongTon ?? 0)</h3>
                    </div>
                    <div class="col-md-4">
                        <h5>Sản Phẩm Hết Hàng</h5>
                        <h3 class="text-danger">@Model.Count(s => (s.SoLuongTon ?? 0) <= 0)</h3>
                    </div>
                    <div class="col-md-4">
                        <h5>Tổng Sản Phẩm</h5>
                        <h3 class="text-primary">@Model.Count</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info">
    <strong>ℹ️ Lưu ý:</strong> Để nhập hàng và cập nhật số lượng tồn kho, vui lòng sử dụng chức năng <a href="@Url.Action("Create", "PhieuNhap")" class="alert-link"><strong>Nhập Hàng</strong></a>.
</div>

<form id="bulkDeleteForm" method="post" action="@Url.Action("DeleteSelected", "SanPham", new { area = "Admin" })">
    @Html.AntiForgeryToken()

    <table class="table table-bordered table-hover table-datatable">
        <thead class="table-secondary">
            <tr>
                <th style="width:40px;"><input id="chkAll" type="checkbox" title="Chọn tất cả" /></th>
                <th>Mã SP</th>
                <th>Hình Ảnh</th>
                <th>Tên Sản Phẩm</th>
                <th>Nhà Cung Cấp</th>
                <th>Giá Bán</th>
                <th>Tồn Kho</th>
                <th>Hành Động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var sp in Model)
            {
                var tonKhoClass = "badge-success";
                var tonKhoText = sp.SoLuongTon ?? 0;
                
                // Color coding cho tồn kho
                if (tonKhoText == 0)
                {
                    tonKhoClass = "badge-danger";
                }
                else if (tonKhoText < 10)
                {
                    tonKhoClass = "badge-warning";
                }

                // Lấy nhà cung cấp từ phiếu nhập gần nhất
                var recentSupplier = sp.ChiTietPhieuNhaps?
                    .OrderByDescending(ct => ct.PhieuNhap?.NgayNhap)
                    .Select(ct => ct.PhieuNhap?.NhaCungCap?.TenNCC)
                    .FirstOrDefault();

                <tr>
                    <td>
                        <input type="checkbox" name="selectedIds" value="@sp.MaSP" class="chkItem" />
                    </td>
                    <td><strong>@sp.MaSP</strong></td>
                    <td>
                        @if (!string.IsNullOrEmpty(sp.HinhAnh))
                        {
                            <img src="@Url.Content("~/Content/images/" + sp.HinhAnh)" 
                                 alt="@sp.TenSP" 
                                 class="product-thumbnail" />
                        }
                        else
                        {
                            <div class="no-image-placeholder">
                                <i class="fas fa-image"></i>
                            </div>
                        }
                    </td>
                    <td>@sp.TenSP</td>
                    <td>
                        @if (!string.IsNullOrEmpty(recentSupplier))
                        {
                            <span class="badge badge-info">@recentSupplier</span>
                        }
                        else
                        {
                            <span class="text-muted">Chưa có</span>
                        }
                    </td>
                    <td class="fw-bold text-primary">
                        @((sp.GiaBan ?? 0m).ToString("N0")) đ
                    </td>
                    <td>
                        <span class="badge @tonKhoClass" style="font-size: 14px; padding: 8px 12px;">
                            + @tonKhoText +
                        </span>
                    </td>
                    <td>
                        <a class="btn btn-sm btn-primary" href="@Url.Action("Edit", new { id = sp.MaSP })" title="Sửa">✏️</a>
                        <a class="btn btn-sm btn-danger" href="@Url.Action("Delete", new { id = sp.MaSP })" 
                           onclick="return confirm('Bạn chắc chắn muốn xóa sản phẩm này?')" title="Xóa">🗑️</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>

<form id="deleteAllForm" method="post" action="@Url.Action("DeleteAll", "SanPham", new { area = "Admin" })" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section scripts {
    <script>
        // Chọn / bỏ chọn tất cả
        document.getElementById('chkAll').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.chkItem').forEach(ch => ch.checked = checked);
        });

        // Xóa nhiều sản phẩm đã chọn
        document.getElementById('btnDeleteSelected').addEventListener('click', function (e) {
            e.preventDefault();

            const selected = Array.from(document.querySelectorAll('.chkItem:checked')).map(c => c.value);
            if (selected.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm để xóa.');
                return;
            }

            if (!confirm('Bạn chắc chắn muốn xóa ' + selected.length + ' sản phẩm đã chọn?')) return;

            const form = document.getElementById('bulkDeleteForm');

            // Xóa các input cũ nếu có
            document.querySelectorAll('input[name="idsToDelete"]').forEach(n => n.remove());

            // Thêm các id được chọn vào form
            selected.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'idsToDelete';
                input.value = id;
                form.appendChild(input);
            });

            form.submit();
        });

        // Xóa tất cả sản phẩm
        document.getElementById('btnDeleteAll').addEventListener('click', function (e) {
            e.preventDefault();

            const totalProducts = @Model.Count;
            if (totalProducts === 0) {
                alert('Không có sản phẩm nào để xóa.');
                return;
            }

            if (!confirm('⚠️ CẢNH BÁO: Bạn chắc chắn muốn xóa TẤT CẢ ' + totalProducts + ' sản phẩm?\n\nHành động này không thể hoàn tác!')) return;

            // Xác nhận lần 2
            if (!confirm('Xác nhận lần cuối: Xóa TẤT CẢ sản phẩm?')) return;

            document.getElementById('deleteAllForm').submit();
        });
    </script>
}

<style>
    .table-datatable {
        font-size: 13px;
    }
    
    .product-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .no-image-placeholder {
        width: 60px;
        height: 60px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 24px;
    }
    
    .badge-success { background-color: #28a745; }
    .badge-warning { background-color: #ffc107; color: #000; }
    .badge-danger { background-color: #dc3545; }
    .badge-info { background-color: #17a2b8; }
    .badge-secondary { background-color: #6c757d; }
    .badge-primary { background-color: #007bff; }

    .me-2 {
        margin-right: 0.5rem;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }

    .align-items-center {
        align-items: center;
    }
</style>
