@model WebApplication15.Models.KhuyenMai

@{
    ViewBag.Title = "Tạo Khuyến mãi mới";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    List<SelectListItem> listProducts = ViewBag.Products as List<SelectListItem>;
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Tạo Khuyến mãi mới</h1>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Thông tin chi tiết</h6>
                </div>
                <div class="card-body">
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                    <div class="form-group">
                        <label>Tên chương trình <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.TenChuongTrinh, new { @class = "form-control", placeholder = "Ví dụ: Sale Black Friday" })
                        @Html.ValidationMessageFor(m => m.TenChuongTrinh, "", new { @class = "text-danger" })
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Mã Code (Voucher) <span class="text-danger">*</span></label>
                                @Html.TextBoxFor(m => m.MaCode, new { @class = "form-control text-uppercase font-weight-bold", placeholder = "SALE50" })
                                @Html.ValidationMessageFor(m => m.MaCode, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Loại giảm giá</label>
                                @Html.DropDownListFor(m => m.LoaiGiamGia, new SelectList(new[] {
                                    new { Value = "PhanTram", Text = "Theo Phần trăm (%)" },
                                    new { Value = "TienMat", Text = "Theo Tiền mặt (VNĐ)" },
                                }, "Value", "Text"), new { @class = "form-control" })
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Giá trị giảm</label>
                                @Html.TextBoxFor(m => m.GiaTriGiam, new { @class = "form-control", type = "number", min = "0" })
                                @Html.ValidationMessageFor(m => m.GiaTriGiam, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Giảm tối đa (Nếu là %)</label>
                                @Html.TextBoxFor(m => m.GiamToiDa, new { @class = "form-control", type = "number", min = "0" })
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Đơn tối thiểu</label>
                                @Html.TextBoxFor(m => m.DonHangToiThieu, new { @class = "form-control", type = "number", min = "0" })
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Ngày bắt đầu</label>
                                @Html.TextBoxFor(m => m.NgayBatDau, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Ngày kết thúc</label>
                                @Html.TextBoxFor(m => m.NgayKetThuc, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                @Html.ValidationMessageFor(m => m.NgayKetThuc, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Số lượng phát hành</label>
                                @Html.TextBoxFor(m => m.SoLuongPhatHanh, new { @class = "form-control", type = "number", min = "1", value = (Model?.SoLuongPhatHanh ?? 0) })
                                <small class="form-text text-muted">Số lần tối đa mã được dùng</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Trạng thái</label>
                                @Html.DropDownListFor(m => m.TrangThai, new List<SelectListItem> {
                                    new SelectListItem { Text = "Phát hành (Active)", Value = "true", Selected = (Model?.TrangThai ?? false) },
                                    new SelectListItem { Text = "Chưa phát hành (Draft)", Value = "false", Selected = (!(Model?.TrangThai ?? false)) }
                                }, new { @class = "form-control custom-select" })
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow mb-3">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Phạm vi áp dụng</h6>
                </div>
                <div class="card-body">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ScopeOption" id="scopeAll" value="all" checked onchange="toggleScope()">
                        <label class="form-check-label font-weight-bold" for="scopeAll">
                            <i class="fas fa-shopping-cart"></i> Toàn bộ đơn hàng
                        </label>
                    </div>
                    <div class="form-check form-check-inline ml-2">
                        <input class="form-check-input" type="radio" name="ScopeOption" id="scopeProduct" value="product" onchange="toggleScope()">
                        <label class="form-check-label font-weight-bold" for="scopeProduct">
                            <i class="fas fa-tshirt"></i> Sản phẩm cụ thể
                        </label>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4" id="productSelectionSection" style="display:none;">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Chọn Sản phẩm</h6>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAll()">Chọn tất cả</button>
                </div>
                <div class="card-body p-0">
                    <div class="input-group p-2">
                        <input type="text" class="form-control form-control-sm" id="searchProduct" placeholder="Tìm sản phẩm...">
                    </div>

                    <div class="overflow-auto" style="max-height: 400px;">
                        <ul class="list-group list-group-flush" id="productList">
                            @if (listProducts != null)
                            {
                                foreach (var item in listProducts)
                                {
                                    <li class="list-group-item">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input product-item"
                                                   id="prod_@item.Value" name="SelectedProductIds"
                                                   value="@item.Value" @(item.Selected ? "checked" : "")>
                                            <label class="custom-control-label" for="prod_@item.Value">
                                                @item.Text
                                            </label>
                                        </div>
                                    </li>
                                }
                            }
                        </ul>
                    </div>
                    <div class="p-2 text-muted small bg-light">
                        * Chỉ những sản phẩm được chọn mới được giảm giá.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-group mt-3 text-center">
        <button type="submit" class="btn btn-success btn-lg px-5"><i class="fa fa-save"></i> Hoàn tất</button>
        <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">Hủy</a>
    </div>
}

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // Hàm bật tắt hiển thị danh sách sản phẩm
        function toggleScope() {
            var isProductScope = document.getElementById("scopeProduct").checked;
            var section = document.getElementById("productSelectionSection");

            if (isProductScope) {
                $(section).slideDown(); // Hiện danh sách
            } else {
                $(section).slideUp();   // Ẩn danh sách
                // Reset checkbox (tùy chọn)
                //$('.product-item').prop('checked', false);
            }
        }

        $(document).ready(function () {
            // Gọi 1 lần khi trang load
            toggleScope();

            // Script tìm kiếm nhanh
            $("#searchProduct").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#productList li").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        // Script chọn tất cả
        function toggleAll() {
            var checkboxes = $('.product-item');
            var allChecked = checkboxes.length === checkboxes.filter(':checked').length;
            checkboxes.prop('checked', !allChecked);
        }
    </script>
}