using System;
using System.Collections.Generic;
using System.Linq;
using WebApplication15.Models;
using System.Data.Entity;

namespace WebApplication15.Services
{
    public class CouponService
    {
        private readonly DB_SkinFood1Entities _db;

        public CouponService(DB_SkinFood1Entities db)
        {
            _db = db ?? new DB_SkinFood1Entities();
        }

        /// <summary>
        /// Hàm này CHỈ TÍNH TOÁN số tiền giảm giá để hiển thị cho khách xem.
        /// KHÔNG lưu thay đổi vào database ở đây.
        /// Coupon được áp dụng trên "giá hiệu dụng" của sản phẩm (sau các giảm giá mặc định trên SP như SanPham.GiamGia).
        /// </summary>
        public decimal CalculateDiscount(string couponCode, List<CartItem> cartItems, decimal totalOrderValue)
        {
            if (string.IsNullOrEmpty(couponCode))
                throw new ArgumentException("Mã không được để trống", nameof(couponCode));

            var km = _db.KhuyenMais.FirstOrDefault(x => x.MaCode == couponCode);

            // 1. Các bước Validate cơ bản
            if (km == null)
                throw new InvalidOperationException("Mã giảm giá không tồn tại");

            if (km.TrangThai.HasValue && km.TrangThai.Value == false)
                throw new InvalidOperationException("Chương trình khuyến mãi này đang tạm dừng");

            var now = DateTime.Now;
            if (km.NgayBatDau.HasValue && now.Date < km.NgayBatDau.Value.Date)
                throw new InvalidOperationException("Mã chưa đến thời gian áp dụng");

            if (km.NgayKetThuc.HasValue && now.Date > km.NgayKetThuc.Value.Date)
                throw new InvalidOperationException("Mã đã hết hạn sử dụng");

            // 2. Validate số lượng (Check trước, chưa trừ)
            if ((km.SoLuongPhatHanh ?? 0) > 0 && (km.SoLuongDaDung ?? 0) >= km.SoLuongPhatHanh.Value)
                throw new InvalidOperationException("Mã này đã hết lượt sử dụng");

            if (totalOrderValue < (km.DonHangToiThieu ?? 0m))
                throw new InvalidOperationException($"Đơn hàng phải tối thiểu {km.DonHangToiThieu:N0}đ để áp dụng mã này");

            // 3. Xác định phạm vi áp dụng (Toàn bộ hay Sản phẩm cụ thể)
            // Load danh sách sản phẩm được áp dụng mã này
            _db.Entry(km).Collection(k => k.SanPhams).Load();
            var appliedProductIds = km.SanPhams?.Select(s => s.MaSP).ToList() ?? new List<int>();

            decimal baseAmount = 0m;

            // Helper: compute effective line total for a cart item taking into account product-level discount (SanPham.GiamGia as %)
            Func<CartItem, decimal> effectiveLine = (item) =>
            {
                // If cart item provides DonGia already after product discount, prefer that. Otherwise read product discount from DB.
                decimal unit = item.DonGia;

                // Try to get product-level percent discount from DB to compute effective price
                try
                {
                    var sp = _db.SanPhams.Find(item.MaSP);
                    if (sp != null && sp.GiamGia.HasValue && sp.GiamGia.Value > 0)
                    {
                        var pct = sp.GiamGia.Value / 100m;
                        unit = unit * (1 - pct);
                    }
                }
                catch
                {
                    // ignore DB read errors and fallback to item.DonGia
                }

                return unit * item.SoLuong;
            };

            // Nếu không chọn sản phẩm nào cụ thể -> Áp dụng toàn đơn hàng
            if (appliedProductIds.Count == 0)
            {
                // compute baseAmount as sum of effective lines (so coupon applies on top of product discounts)
                if (cartItems != null && cartItems.Count > 0)
                {
                    baseAmount = cartItems.Sum(ci => effectiveLine(ci));
                }
                else
                {
                    // fallback to provided totalOrderValue
                    baseAmount = totalOrderValue;
                }
            }
            else
            {
                // Chỉ tính tổng tiền của các sản phẩm nằm trong danh sách khuyến mãi (tính theo giá hiệu dụng)
                if (cartItems != null && cartItems.Count > 0)
                {
                    foreach (var item in cartItems)
                    {
                        if (appliedProductIds.Contains(item.MaSP))
                        {
                            baseAmount += effectiveLine(item);
                        }
                    }
                }

                // Nếu mã chỉ áp dụng cho SP A, mà giỏ hàng toàn SP B thì baseAmount = 0
                if (baseAmount == 0)
                    throw new InvalidOperationException("Mã này không áp dụng cho các sản phẩm trong giỏ của bạn");
            }

            // 4. Tính toán giá trị giảm
            decimal discount = 0m;

            if (!string.IsNullOrEmpty(km.LoaiGiamGia) && km.LoaiGiamGia.Equals("TienMat", StringComparison.OrdinalIgnoreCase))
            {
                discount = km.GiaTriGiam;
            }
            else // Mặc định là phần trăm
            {
                discount = baseAmount * (km.GiaTriGiam / 100m);

                // Kiểm tra giảm tối đa (Chỉ áp dụng cho %)
                if (km.GiamToiDa.HasValue && km.GiamToiDa.Value > 0 && discount > km.GiamToiDa.Value)
                {
                    discount = km.GiamToiDa.Value;
                }
            }

            // Đảm bảo không giảm quá giá trị đơn hàng
            var effectiveOrderTotal = (cartItems != null && cartItems.Count > 0) ? cartItems.Sum(ci => effectiveLine(ci)) : totalOrderValue;
            if (discount > effectiveOrderTotal) discount = effectiveOrderTotal;
            if (discount < 0) discount = 0m;

            return discount;
        }

        /// <summary>
        /// Hàm này gọi ở Controller "Checkout/Payment" KHI VÀ CHỈ KHI đơn hàng được tạo thành công.
        /// Nhiệm vụ: Tăng số lượng đã dùng lên 1.
        /// </summary>
        public void MarkCouponUsed(string couponCode)
        {
            if (string.IsNullOrEmpty(couponCode)) return;

            var km = _db.KhuyenMais.FirstOrDefault(x => x.MaCode == couponCode);
            if (km != null)
            {
                km.SoLuongDaDung = (km.SoLuongDaDung ?? 0) + 1;
                _db.Entry(km).State = EntityState.Modified;
                _db.SaveChanges();
            }
        }
    }
}