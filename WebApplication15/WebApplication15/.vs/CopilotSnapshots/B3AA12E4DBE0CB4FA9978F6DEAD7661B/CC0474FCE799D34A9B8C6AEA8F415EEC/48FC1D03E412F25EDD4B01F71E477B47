@model WebApplication15.Models.SanPham
@{
    ViewBag.Title = Model.TenSP;

    // Giữ nguyên logic tính toán của bạn
    decimal giaGiam = Model.GiaBan ?? 0m;
    bool hasDiscount = (Model.GiamGia ?? 0m) > 0m;
    if (hasDiscount)
    {
        giaGiam = (Model.GiaBan ?? 0m) * (1m - ((Model.GiamGia ?? 0m) / 100m));
    }
}
<link href="~/CSS/DanhGiaSoSao.css" rel="stylesheet" />

<div class="container my-5">
    @* --- PHẦN 1: THÔNG TIN SẢN PHẨM --- *@
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-body p-4">
            <div class="row">
                @* Cột Ảnh *@
                <div class="col-md-5 text-center">
                    <div class="p-3 border rounded bg-light d-flex align-items-center justify-content-center" style="min-height: 400px;">
                        <img src="~/Content/images/@Model.HinhAnh" alt="@Model.TenSP" class="img-fluid" style="max-height: 400px; object-fit: contain;" />
                    </div>
                </div>

                @* Cột Thông Tin *@
                <div class="col-md-7 mt-4 mt-md-0">
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb bg-transparent p-0">
                            <li class="breadcrumb-item"><a href="#" class="text-muted">Trang chủ</a></li>
                            <li class="breadcrumb-item text-muted">@ViewBag.TenDanhMuc</li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.TenSP</li>
                        </ol>
                    </nav>

                    <h2 class="font-weight-bold text-dark mb-3">@Model.TenSP</h2>

                    <div class="mb-3">
                        <span class="badge bg-info text-white me-2 p-2">@ViewBag.TenThuongHieu</span>
                        <span class="badge bg-secondary text-white p-2">@Model.LoaiSP.TenLoai</span>
                    </div>

                    @* Giá bán *@
                    <div class="mb-4">
                        @if (hasDiscount)
                        {
                            <div class="d-flex align-items-center">
                                <h3 class="text-danger font-weight-bold mb-0 me-3">@String.Format("{0:N0} đ", giaGiam)</h3>
                                <span class="text-muted text-decoration-line-through me-2">@String.Format("{0:N0} đ", Model.GiaBan)</span>
                                <span class="badge bg-danger">-@Model.GiamGia%</span>
                            </div>
                        }
                        else
                        {
                            <h3 class="text-primary font-weight-bold">@String.Format("{0:N0} đ", Model.GiaBan)</h3>
                        }
                    </div>

                    @* Tính toán trạng thái (Logic cũ giữ nguyên) *@
                    @{
                        string trangThai = !string.IsNullOrEmpty(Model.TrangThaiSanPham) ? Model.TrangThaiSanPham : ((Model.SoLuongTon ?? 0) > 0 ? "Còn hàng" : "Hết hàng");
                        bool canBuy = true;
                        if (!string.IsNullOrEmpty(Model.TrangThaiSanPham))
                        {
                            var tt = Model.TrangThaiSanPham.Trim().ToLower();
                            if (tt == "hết hàng" || tt == "ngừng kinh doanh" || tt == "ngừng bán" || tt == "tạm ngưng") { canBuy = false; }
                        }
                        else if ((Model.SoLuongTon ?? 0) <= 0) { canBuy = false; }
                        ViewBag._TrangThai = trangThai;
                        ViewBag._CanBuy = canBuy;
                    }

                    <div class="mb-4">
                        <p class="mb-1">Tình trạng:</p>
                        @if ((bool)ViewBag._CanBuy)
                        {
                            <span class="text-success font-weight-bold"><i class="bi bi-check-circle-fill"></i> @ViewBag._TrangThai</span>
                        }
                        else
                        {
                            <span class="text-danger font-weight-bold"><i class="bi bi-x-circle-fill"></i> @ViewBag._TrangThai</span>
                        }
                    </div>

                    <hr />

                    @* Nút mua hàng *@
                    <div class="d-flex gap-2">
                        @if ((bool)ViewBag._CanBuy)
                        {
                            <a href="@Url.Action("AddToCart", "GioHang", new { id = Model.MaSP })" class="btn btn-primary btn-lg shadow-sm px-5">
                                <i class="bi bi-cart-plus me-2"></i> THÊM VÀO GIỎ
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-secondary btn-lg px-5" disabled>
                                <i class="bi bi-slash-circle me-2"></i> TẠM HẾT HÀNG
                            </button>
                        }
                        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary btn-lg" title="Quay lại">
                            <i class="bi bi-arrow-return-left"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- PHẦN 2: TABS MÔ TẢ & ĐÁNH GIÁ --- *@
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-white border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active font-weight-bold" id="mota-tab" data-toggle="tab" href="#mota" role="tab">Mô Tả Sản Phẩm</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold" id="danhgia-tab" data-bs-toggle="tab" href="#danhgia" role="tab">
                        Đánh Giá (@(((List<WebApplication15.Models.DanhGia>)ViewBag.DanhSachDanhGia)?.Count ?? 0))
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="myTabContent">
                @* Tab Mô tả *@
                <div class="tab-pane fade show active py-3 px-2" id="mota" role="tabpanel">
                    <div class="product-description">
                        @Html.Raw(Model.MoTa)
                    </div>
                </div>

                @* Tab Đánh giá *@
                <div class="tab-pane fade py-3 px-2" id="danhgia" role="tabpanel">
                    @* Danh sách đánh giá *@
                    <div class="mb-4">
                        @Html.Partial("_DanhSachDanhGia", (List<WebApplication15.Models.DanhGia>)ViewBag.DanhSachDanhGia)
                    </div>

                    <hr class="my-4" />

                    @* Form đánh giá *@
                    @if (Session["User"] != null)
                    {
                        <div class="bg-light p-4 rounded border">
                            <h5 class="font-weight-bold mb-3">Viết đánh giá của bạn</h5>
                            <form method="post" action="@Url.Action("ThemDanhGia", "Home")">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="MaSP" value="@Model.MaSP" />

                                @* Put stars to the left of the label using flex *@
                                <div class="form-group mb-3 d-flex align-items-center">
                                    <div class="star-rating me-3">
                                        <input type="radio" id="star5" name="Diem" value="5" /><label for="star5">★</label>
                                        <input type="radio" id="star4" name="Diem" value="4" /><label for="star4">★</label>
                                        <input type="radio" id="star3" name="Diem" value="3" /><label for="star3">★</label>
                                        <input type="radio" id="star2" name="Diem" value="2" /><label for="star2">★</label>
                                        <input type="radio" id="star1" name="Diem" value="1" required /><label for="star1">★</label>
                                    </div>
                                    <label class="font-weight-bold mb-0">Mức độ hài lòng:</label>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="font-weight-bold">Nội dung đánh giá:</label>
                                    <textarea name="NoiDung" class="form-control" rows="3" placeholder="Chia sẻ cảm nhận về sản phẩm..." required></textarea>
                                </div>

                                <button class="btn btn-primary px-4">Gửi đánh giá</button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            Vui lòng <a href="/User/Login" class="alert-link font-weight-bold">Đăng nhập</a> để viết đánh giá.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @* --- PHẦN 3: SẢN PHẨM LIÊN QUAN --- *@
    @if (ViewBag.SanPhamLienQuan is List<WebApplication15.Models.SanPham> spLienQuanList && spLienQuanList.Any())
    {
        <div class="related-products mt-5">
            <h4 class="font-weight-bold mb-4 border-bottom pb-2">Sản Phẩm Liên Quan</h4>
            <div class="row">
                @foreach (var sp in spLienQuanList)
                {
                    <div class="col-6 col-md-3 mb-4">
                        <div class="card h-100 shadow-sm border-0 product-card-hover">
                            <a href="@Url.Action("ChiTietSP", "Home", new { maSP = sp.MaSP })" class="text-decoration-none text-dark">
                                <div class="position-relative overflow-hidden">
                                    <img src="~/Content/images/@sp.HinhAnh" class="card-img-top p-3" alt="@sp.TenSP" style="height: 200px; object-fit: contain;">
                                    @if ((sp.GiamGia ?? 0) > 0)
                                    {
                                        <span class="position-absolute top-0 start-0 badge bg-danger m-2">
                                            -@sp.GiamGia%
                                        </span>
                                    }
                                </div>
                                <div class="card-body text-center d-flex flex-column">
                                    <h6 class="card-title text-truncate font-weight-bold" title="@sp.TenSP">@sp.TenSP</h6>
                                    <div class="mt-auto">
                                        @if ((sp.GiamGia ?? 0) > 0)
                                        {
                                            <div class="text-danger font-weight-bold">@((sp.GiaBan.Value * (1 - (sp.GiamGia/100)))?.ToString("N0")) đ</div>
                                            <div class="text-muted small text-decoration-line-through">@sp.GiaBan.Value.ToString("N0") đ</div>
                                        }
                                        else
                                        {
                                            <div class="text-primary font-weight-bold">@sp.GiaBan.Value.ToString("N0") đ</div>
                                        }
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>