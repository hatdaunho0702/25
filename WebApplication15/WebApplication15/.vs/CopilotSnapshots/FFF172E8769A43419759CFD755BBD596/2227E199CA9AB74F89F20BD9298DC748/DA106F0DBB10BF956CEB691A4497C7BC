using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using WebApplication15.Areas.Admin.Data;
using WebApplication15.Models;

namespace WebApplication15.Areas.Admin.Controllers
{
    [AuthorizeAdmin]
    public class DashboardController : Controller
    {
        private DB_SkinFood1Entities db = new DB_SkinFood1Entities();

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                db?.Dispose();
            }
            base.Dispose(disposing);
        }

        // GET: Admin/Dashboard
        public ActionResult Index()
        {
            // Thống kê cơ bản
            var totalSanPham = db.SanPhams.Count();
            var totalDonHang = db.DonHangs.Count();
            var totalTaiKhoan = db.TaiKhoans.Count();
            var totalNguoiDung = db.NguoiDungs.Count();

            ViewBag.TotalSanPham = totalSanPham;
            ViewBag.TotalDonHang = totalDonHang;
            ViewBag.TotalTaiKhoan = totalTaiKhoan;
            ViewBag.TotalNguoiDung = totalNguoiDung;

            // Cảnh báo sản phẩm sắp hết hạn (còn 3 tháng)
            var ngayHienTai = DateTime.Now;
            var ngaySauBaThangs = ngayHienTai.AddMonths(3);

            var sanPhamList = db.SanPhams.ToList();

            var sanPhamSapHetHan = sanPhamList
                .Where(sp => sp.HanSuDung.HasValue 
                    && sp.HanSuDung > ngayHienTai 
                    && sp.HanSuDung <= ngaySauBaThangs)
                .OrderBy(sp => sp.HanSuDung)
                .ToList();

            var sanPhamDaHetHan = sanPhamList
                .Where(sp => sp.HanSuDung.HasValue && sp.HanSuDung <= ngayHienTai)
                .OrderBy(sp => sp.HanSuDung)
                .ToList();

            // Thống kê tồn kho
            var soLuongTonTatCa = sanPhamList.Sum(sp => sp.SoLuongTon) ?? 0;
            var sanPhamHetHang = sanPhamList.Where(sp => sp.SoLuongTon <= 0).Count();

            ViewBag.SanPhamSapHetHan = sanPhamSapHetHan;
            ViewBag.SanPhamDaHetHan = sanPhamDaHetHan;
            ViewBag.SoLuongTonTatCa = soLuongTonTatCa;
            ViewBag.SanPhamHetHang = sanPhamHetHang;

            // Doanh thu tháng này
            var ngayDauThang = new DateTime(ngayHienTai.Year, ngayHienTai.Month, 1);
            var doanhThuThangNay = db.DonHangs
                .Where(dh => dh.NgayDat >= ngayDauThang && dh.NgayDat <= ngayHienTai)
                .Sum(dh => dh.TongTien) ?? 0;

            ViewBag.DoanhThuThangNay = doanhThuThangNay;

            // ======================================
            // THỐNG KÊ THANH TOÁN
            // ======================================

            // Lấy tất cả đơn hàng vào memory trước
            var allDonHangs = db.DonHangs.ToList();

            // Đơn hàng đã thanh toán
            var donHangDaThanhToan = allDonHangs
                .Where(dh => dh.TrangThaiThanhToan == "Đã thanh toán" || dh.TrangThaiThanhToan == "Paid")
                .ToList();

            // Đơn hàng chưa thanh toán
            var donHangChuaThanhToan = allDonHangs
                .Where(dh => dh.TrangThaiThanhToan == "Chưa thanh toán" || dh.TrangThaiThanhToan == "Pending" || string.IsNullOrEmpty(dh.TrangThaiThanhToan))
                .ToList();

            // Doanh thu từ các đơn hàng đã thanh toán
            var doanhThuDaThanhToan = donHangDaThanhToan.Sum(dh => dh.TongTien) ?? 0;

            // Doanh thu từ các đơn hàng chưa thanh toán
            var doanhThuChuaThanhToan = donHangChuaThanhToan.Sum(dh => dh.TongTien) ?? 0;

            ViewBag.DonHangDaThanhToan = donHangDaThanhToan.Count;
            ViewBag.DonHangChuaThanhToan = donHangChuaThanhToan.Count;
            ViewBag.DoanhThuDaThanhToan = doanhThuDaThanhToan;
            ViewBag.DoanhThuChuaThanhToan = doanhThuChuaThanhToan;

            // Top 10 đơn hàng chưa thanh toán (sắp xếp theo ngày cũ nhất)
            var donHangChuaThanhToanTop10 = donHangChuaThanhToan
                .OrderBy(dh => dh.NgayDat)
                .Take(10)
                .ToList();

            ViewBag.DonHangChuaThanhToanTop10 = donHangChuaThanhToanTop10;

            // Đơn hàng đã thanh toán tháng này
            var donHangDaThanhToanThangNay = donHangDaThanhToan
                .Where(dh => dh.NgayDat >= ngayDauThang && dh.NgayDat <= ngayHienTai)
                .Count();

            ViewBag.DonHangDaThanhToanThangNay = donHangDaThanhToanThangNay;

            // ======================================
            // THỐNG KÊ DOANH THU CHO BIỂU ĐỒ
            // ======================================

            // Doanh thu theo ngày (7 ngày gần nhất)
            var doanhThuTheoNgay = new List<decimal>();
            var labelTheoNgay = new List<string>();
            
            for (int i = 6; i >= 0; i--)
            {
                var ngay = ngayHienTai.AddDays(-i);
                var ngayBatDau = ngay.Date;
                var ngayKetThuc = ngayBatDau.AddDays(1);
                
                var doanhThu = allDonHangs
                    .Where(dh => dh.NgayDat >= ngayBatDau && dh.NgayDat < ngayKetThuc)
                    .Sum(dh => dh.TongTien) ?? 0;
                
                doanhThuTheoNgay.Add(doanhThu);
                labelTheoNgay.Add(ngay.ToString("dd/MM"));
            }

            // Doanh thu theo tháng (12 tháng gần nhất)
            var doanhThuTheoThang = new List<decimal>();
            var labelTheoThang = new List<string>();
            
            for (int i = 11; i >= 0; i--)
            {
                var thang = ngayHienTai.AddMonths(-i);
                var ngayDauThangTemp = new DateTime(thang.Year, thang.Month, 1);
                var ngayCuoiThang = ngayDauThangTemp.AddMonths(1);
                
                var doanhThu = allDonHangs
                    .Where(dh => dh.NgayDat >= ngayDauThangTemp && dh.NgayDat < ngayCuoiThang)
                    .Sum(dh => dh.TongTien) ?? 0;
                
                doanhThuTheoThang.Add(doanhThu);
                labelTheoThang.Add(thang.ToString("MM/yyyy"));
            }

            // Doanh thu theo năm (5 năm gần nhất)
            var doanhThuTheoNam = new List<decimal>();
            var labelTheoNam = new List<string>();
            
            for (int i = 4; i >= 0; i--)
            {
                var nam = ngayHienTai.Year - i;
                var ngayDauNam = new DateTime(nam, 1, 1);
                var ngayCuoiNam = new DateTime(nam, 12, 31).AddDays(1);
                
                var doanhThu = allDonHangs
                    .Where(dh => dh.NgayDat >= ngayDauNam && dh.NgayDat < ngayCuoiNam)
                    .Sum(dh => dh.TongTien) ?? 0;
                
                doanhThuTheoNam.Add(doanhThu);
                labelTheoNam.Add(nam.ToString());
            }

            // Chuyển sang JSON để dùng trong JavaScript
            ViewBag.DoanhThuTheoNgay = Newtonsoft.Json.JsonConvert.SerializeObject(doanhThuTheoNgay);
            ViewBag.LabelTheoNgay = Newtonsoft.Json.JsonConvert.SerializeObject(labelTheoNgay);
            
            ViewBag.DoanhThuTheoThang = Newtonsoft.Json.JsonConvert.SerializeObject(doanhThuTheoThang);
            ViewBag.LabelTheoThang = Newtonsoft.Json.JsonConvert.SerializeObject(labelTheoThang);
            
            ViewBag.DoanhThuTheoNam = Newtonsoft.Json.JsonConvert.SerializeObject(doanhThuTheoNam);
            ViewBag.LabelTheoNam = Newtonsoft.Json.JsonConvert.SerializeObject(labelTheoNam);

            return View();
        }
    }
}